    # ğŸ§  Mission 5 â€” Backend Node.js + Prisma + JWT Auth

    Projeto backend desenvolvido com **Node.js**, **Express**, **Prisma**, **JWT** e **Jest**, integrando autenticaÃ§Ã£o, middlewares, testes e estrutura de banco relacional.
    Objetivo: demonstrar domÃ­nio completo de backend moderno com boas prÃ¡ticas, testes e documentaÃ§Ã£o.

    ---

    ## ğŸš€ InÃ­cio rÃ¡pido
    ```bash
    # 1. Inicializar projeto (caso ainda nÃ£o exista)
    npm init -y
    ```

    ---

    ## ğŸ“¦ DependÃªncias

    ### Principais

    ```bash
    npm install bcrypt chalk cors dotenv express
    ```

    ### Desenvolvimento
    ```bash
    npm install --save-dev @types/express nodemon jest supertest eslint
    ```

    ---

    ## ğŸ§¹ Lint e formataÃ§Ã£o
    ```bash
    # Verificar erros de lint
    npm run lint
    # Corrigir automaticamente
    npm run lint:fix
    ```

    # 1ï¸âƒ£ Instala o commitlint
    npm i -D @commitlint/config-conventional @commitlint/cli
    bash
    Copiar cÃ³digo

    # 2ï¸âƒ£ Cria o arquivo de configuraÃ§Ã£o
    echo "export default { extends: ['@commitlint/config-conventional'] };" > commitlint.config.js
    bash
    Copiar cÃ³digo

    # 3ï¸âƒ£ Adiciona o hook commit-msg no Husky
    npx husky add .husky/commit-msg 'npx --no-install commitlint --edit $1'

    ---

    ## ğŸ—„ï¸ Banco de Dados (Prisma + PostgreSQL)
    		```bash
    		npm install @prisma/client
    		npm install --save-dev prisma

    		# 1ï¸âƒ£ Inicializar Prisma
    		npx prisma init

    		# 2ï¸âƒ£ Cria/edita schema.prisma

    		# 3ï¸âƒ£ Gera e EXECUTA primeira migration:
    		npx prisma migrate dev --name init'

    		# 4ï¸âƒ£  Verificar status:
    		npx prisma migrate status
    		```

    	---

    ## âš™ï¸ Scripts Ãºteis
    Adicione estes scripts ao `package.json` (caso ainda nÃ£o estejam):

    ```json
    "scripts": {
    	"dev": "nodemon src/server.js",
    	"test": "jest",
    	"lint": "eslint .",
    	"lint:fix": "eslint . --fix",
    	"db:push": "prisma db push",
    	"db:migrate": "prisma migrate deploy",
    	"db:seed": "node prisma/seed.js",
    	"start": "node src/server.js"
    }
    ```

    ---

    ## ğŸ§ª Testes
    ```bash
    npm test

    Teste especifico:
    npm test -- -t "success function"
    npm test -- _tests_/middlewares/successHandler.test.js
    ```

    Framework: **Jest + Supertest**
    Inclui testes de integraÃ§Ã£o (`/auth/login`, `/auth/logout`, `/auth/register`, `/me`) e unitÃ¡rios (`signJwt`, `allowRoles`, `tokenDenylist.memory`, etc).

    ---

    ## ğŸ” Commits e histÃ³rico
    ```bash
    # Ver commits resumidos
    git log --oneline --graph --decorate
    ```

    Exemplo de histÃ³rico:

    ```
    * f1ae606 (HEAD -> master) DB WITH MIDDLEWARE TESTS DONE NOW
    * d0488bb db tests with helpers done
    * 6e7128a helpers middlewares and its tests done
    * fee4bc2 db structure done
    * fb66780 skeleton done
    ```

    ---

    ## âš™ï¸ Arquivo `.env.example`

    ```bash
    DATABASE_URL="postgresql://user:password@localhost:5432/mission5?schema=public"
    JWT_SECRET="dev-secret"
    JWT_EXPIRES_IN="1d"
    PORT=3000
    ```

    ---

    ## ğŸ›¡ï¸ Authorization Guards
    **`isSelfOrRoles`** - Primary guard for resource-based permissions (95% of use cases)
    **`allowRoles`** - Situational guard for global role-based access (5% of use cases)

    **Usage:** `app.get('/users/:id', authRequired, isSelfOrRoles('ADMIN'), handler)`
    **Covers:** User accesses own data OR has specific roles - perfect for user profiles and owned resources

    ## ESTRUTURA DO PROJETO
    1ï¸âƒ£ FundaÃ§Ã£o do Projeto
    â€ƒREADME Â· package.json Â· .gitignore

    2ï¸âƒ£ Ambiente e Config SensÃ­veis
    â€ƒ.env Â· .env.test

    3ï¸âƒ£ Pipeline de Qualidade e SemÃ¢ntica
    â€ƒ.editorconfig Â· eslint.config Â· .eslintignore Â· .prettierrc Â· pre-commit Â· commit-msg Â· husky.sh Â· commitlint.config.js Â· logger.js Â· spyConsole.js

    4ï¸âƒ£ Banco de Dados (Prisma)
    â€ƒschema.prisma Â· migrations/ Â· seed.js Â· prisma.js

    5ï¸âƒ£ Middleware Helpers
    â€ƒsuccess.js Â· successHandler.js Â· AppError.js Â· errorHandler.js (+ tests)

    6ï¸âƒ£ ConfiguraÃ§Ã£o Global e Testes
    â€ƒjest.config.cjs Â· jest.setup.env.cjs Â· globalSetup.cjs

    7ï¸âƒ£ Testes de Integridade de Banco
    â€ƒuser.db.test.js Â· app.bridge.userToDb.js Â· bridge.http.test.js

    8ï¸âƒ£ JWT Core
    â€ƒsignJwt.js Â· verifyJwt.js (+ tests)

    9ï¸âƒ£ JWT Denylist (RevogaÃ§Ã£o)
    â€ƒtokenDenylist.memory.js (+ tests)

    ğŸ”Ÿ JWT Guards
    â€ƒauthRequired.js Â· allowRoles.js Â· isSelfOrRoles.js (+ tests)

    1ï¸âƒ£1ï¸âƒ£ Rotas de Auth
    â€ƒsanitize Â· register Â· login Â· logout Â· me (+ tests HTTP)

    1ï¸âƒ£2ï¸âƒ£ Rotas de UsuÃ¡rio com RBAC
    â€ƒlist Â· checkEmail Â· meDelete Â· adminDeleteStaff (+ tests)

    1ï¸âƒ£3ï¸âƒ£ Servidor Final
    â€ƒapp.js Â· server.js (+ config de listen / shutdown / Postman) âœ…



    ## ğŸ§­ Estrutura do projeto 	```
    	|-- .COMMANDS
    	|-- .editorconfig
    	|-- .env
    	|-- .env.test
    	|-- .eslintignore
    	|-- .gitignore
    	|-- .husky
    	|   |-- _
    	|   |   |-- .gitignore
    	|   |   |-- applypatch-msg
    	|   |   |-- commit-msg
    	|   |   |-- h
    	|   |   |-- husky.sh
    	|   |   |-- post-applypatch
    	|   |   |-- post-checkout
    	|   |   |-- post-commit
    	|   |   |-- post-merge
    	|   |   |-- post-rewrite
    	|   |   |-- pre-applypatch
    	|   |   |-- pre-auto-gc
    	|   |   |-- pre-commit
    	|   |   |-- pre-merge-commit
    	|   |   |-- pre-push
    	|   |   |-- pre-rebase
    	|   |   `-- prepare-commit-msg
    	|   |-- commit-msg
    	|   `-- pre-commit
    	|-- .prettierrc
    	|-- README
    	|-- _tests_
    	|   |-- MiddlewareHelpers
    	|   |   |-- errorHandler.test.js
    	|   |   `-- successHandler.test.js
    	|   |-- auth
    	|   |   |-- authRoutes
    	|   |   |   |-- auth.login.http.test.js
    	|   |   |   |-- auth.logout.http.test.js
    	|   |   |   `-- auth.register.http.test.js
    	|   |   `-- authenticationConfig
    	|   |       |-- allowRoles.unit.test.js
    	|   |       |-- auth.SMOKE.test.js
    	|   |       |-- authRequired.test.js
    	|   |       |-- isSelforRoles.unit.test.js
    	|   |       |-- signJwt.test.js
    	|   |       |-- tokenDenylist.memory.test.js
    	|   |       `-- verifyJwt.test.js
    	|   |-- bridgeUserRouteTest
    	|   |   |-- app.bridge.userToDb.js
    	|   |   `-- bridge.http.test.js
    	|   |-- setup
    	|   |   `-- globalSetup.cjs
    	|   `-- userRoutes
    	|       |-- adminDeleteRoute.prisma.test.js
    	|       |-- checkEmailRoute.prisma.test.js
    	|       |-- dbTest
    	|       |   `-- user.db.test.js
    	|       |-- listUserRoute.prisma.test.js
    	|       `-- meDeleteRoute.prisma.test.js
    	|-- commitlint.config.js
    	|-- eslint.config.js
    	|-- generated
    	|   `-- prisma
    	|       |-- client.d.ts
    	|       |-- client.js
    	|       |-- default.d.ts
    	|       |-- default.js
    	|       |-- edge.d.ts
    	|       |-- edge.js
    	|       |-- index-browser.js
    	|       |-- index.d.ts
    	|       |-- index.js
    	|       |-- package.json
    	|       |-- query_engine-windows.dll.node
    	|       |-- runtime
    	|       |   |-- edge-esm.js
    	|       |   |-- edge.js
    	|       |   |-- index-browser.d.ts
    	|       |   |-- index-browser.js
    	|       |   |-- library.d.ts
    	|       |   |-- library.js
    	|       |   |-- react-native.js
    	|       |   |-- wasm-compiler-edge.js
    	|       |   `-- wasm-engine-edge.js
    	|       |-- schema.prisma
    	|       |-- wasm.d.ts
    	|       `-- wasm.js
    	|-- jest.config.cjs
    	|-- jest.setup.env.cjs
    	|-- middlewares
    	|   |-- AppError.js
    	|   |-- errorHandler.js
    	|   |-- success.js
    	|   `-- successHandler.js
    	|-- package-lock.json
    	|-- package.json
    	|-- prisma
    	|   |-- migrations
    	|   |   |-- 20250905174117_init
    	|   |   |   `-- migration.sql
    	|   |   |-- 20250905174316_email_ci_rules
    	|   |   |   `-- migration.sql
    	|   |   |-- 20250905175224_email_lowercase_ci
    	|   |   |   `-- migration.sql
    	|   |   `-- migration_lock.toml
    	|   |-- schema.prisma
    	|   `-- seed.js
    	|-- src
    	|   |-- auth
    	|   |   |-- guards
    	|   |   |   |-- allowRoles.js
    	|   |   |   |-- authRequired.js
    	|   |   |   `-- isSelfOrRoles.js
    	|   |   |-- routes
    	|   |   |   |-- loginRoute.js
    	|   |   |   |-- logoutRoute.js
    	|   |   |   `-- registerRoute.js
    	|   |   `-- tokens
    	|   |       |-- signJwt.js
    	|   |       |-- tokenDenylist.memory.js
    	|   |       `-- verifyJwt.js
    	|   |-- users
    	|   |   |-- adminDeleteStaffRoute.js
    	|   |   |-- db
    	|   |   |   `-- prisma.js
    	|   |   |-- emailCheckRoute.js
    	|   |   |-- listUsersRoute.js
    	|   |   `-- meDeleteRoute.js
    	|   `-- utils
    	|       `-- sanitize.js
    	`-- terminalStylization
    			|-- logger.js
    			`-- spyConsole.js
    	```
    ---

    ## COMANDO TREE:
    tree -I 'node_modules|.git|dist|build' -a

    ## ğŸ”‘ Rotas principais (API)

    | MÃ©todo   | Rota             | ProteÃ§Ã£o      | DescriÃ§Ã£o                         |
    | :------- | :--------------- | :------------ | :-------------------------------- |
    | `POST`   | `/auth/register` | pÃºblica       | Cria novo usuÃ¡rio                 |
    | `POST`   | `/auth/login`    | pÃºblica       | Gera token JWT                    |
    | `POST`   | `/auth/logout`   | autenticado   | Revoga token ativo                |
    | `GET`    | `/me`            | autenticado   | Retorna usuÃ¡rio logado            |
    | `GET`    | `/users`         | ADMIN         | Lista usuÃ¡rios                    |
    | `DELETE` | `/users/:id`     | ADMIN ou Self | Remove usuÃ¡rio                    |
    | `GET`    | `/check-email`   | pÃºblica       | Verifica disponibilidade de email |

    ---

    ## ğŸ§° Stack principal
    - Node.js (ESM)
    - Express 5
    - Prisma ORM (PostgreSQL)
    - JWT Auth
    - Jest + Supertest
    - ESLint
    - Dotenv
    - Bcrypt
    - CORS
    - Chalk (para logs)
    - Nodemon

    ---

    ## ğŸ§± Seeds
    Arquivo `prisma/seed.js` cria usuÃ¡rios iniciais (ADMIN e STAFF):

    ```js
    await prisma.user.createMany({
    	data: [
    		{ name: 'Admin', email: 'admin@demo.com', passwordHash: bcrypt.hashSync('admin123', 10), role: 'ADMIN' },
    		{ name: 'Staff', email: 'staff@demo.com', passwordHash: bcrypt.hashSync('staff123', 10), role: 'STAFF' },
    	],
    });
    ```

    ---

    ## ğŸ§© Middlewares
    - `successHandler.js`: injeta `res.success(status, data)`
    - `errorHandler.js`: captura `AppError` e erros Prisma (P2002 â†’ 409, P2025 â†’ 404)
    - `AppError.js`: classe base de erro customizado

    ---

    ## ğŸ§± Testes automatizados

    Pasta `_tests_` cobre:

    - AutenticaÃ§Ã£o (`login`, `logout`, `register`, `me`)
    - Guards (`authRequired`, `allowRoles`, `isSelfOrRoles`)
    - Tokens (`signJwt`, `tokenDenylist.memory`)
    - Middlewares (`successHandler`, `errorHandler`)
    - Rotas de usuÃ¡rio (`list`, `delete`, `check-email`)
    - Banco (`user.db.test.js`)

    ---

    ## ğŸ’¡ ObservaÃ§Ãµes finais

    Este projeto Ã© parte da **Operation Warpath / NeuroCoding Project** (Mission 5).
    Foco: demonstrar domÃ­nio de backend com autenticaÃ§Ã£o JWT, Prisma ORM e testes automatizados.

    Para rodar localmente:

    ```bash
    cp .env.example .env
    npm install
    npm run db:push
    npm run db:seed
    npm run dev
    ```

    Servidor iniciarÃ¡ em: **http://localhost:3000**

    ---

    **Autor:** Gabriel Bussab (Jibrail)
    **Contato:** [linkedin.com/in/gabriel-bussab](https://www.linkedin.com/in/gabriel-bussab)
    **PropÃ³sito:** DemonstraÃ§Ã£o tÃ©cnica para freelas e provas prÃ¡ticas.
    **Status:** ğŸ§© Quase pronto (falta `/me` e ajustes menores antes do deploy final)
